<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDDZk3a0eNyOmKF7ejQ4bLHCA7G38Cb_RI&sensor=true">
</script>
<script type="text/javascript">
  function drawMap(userLocation){
    mapOptions = {
      center: userLocation,
      zoom: 14,
      mapTypeId: google.maps.MapTypeId.ROADMAP
    };

    window.mapObject = new google.maps.Map(document.getElementById("map-canvas"), mapOptions);

    <% @bike_stations.each do |bike_station| %>
      var location = new google.maps.LatLng(<%= bike_station.latitude %>, <%= bike_station.longitude %>);
      new google.maps.Marker({map: window.mapObject, position: location });
    <% end %>

    drawRoute(userLocation, <%= @destination.latitude %>, <%= @destination.longitude %>);
  }

  function geolocationError(positionError){

  }

  function geolocateUser(){
    if (navigator.geolocation) {
      var positionOptions = {
        enableHighAccuracy : true,
        timeout: 10 * 1000
      }
      navigator.geolocation.getCurrentPosition(drawMap(new google.maps.LatLng(position.coords.latitude, position.coords.longitude)), geolocationError, positionOptions);
    }
  }

  function drawRoute(userLocation, destLat, destLong){
    var directionsService = new google.maps.DirectionsService();
    var directionsRequest = {
      origin: userLocation,
      destination: new google.maps.LatLng(destLat, destLong),
      travelMode: google.maps.DirectionsTravelMode.BICYCLING
    }
    directionsService.route(directionsRequest, function(response, status){
      if (status == google.maps.DirectionsStatus.OK){
        new google.maps.DirectionsRenderer({
          map: window.mapObject,
          directions: response
        });
      }
    });
  }

  <% if @origin %>
    google.maps.event.addDomListener(window, 'load', drawMap(new google.maps.LatLng(<%= @origin.latitude %>, <%= @origin.longitude %>)));
  <% else %>
    google.maps.event.addDomListener(window, 'load', geolocateUser);
  <% end %>
</script>